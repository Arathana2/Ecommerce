{% extends 'main.html' %}
{% load static %}
{% block title %}
    Checkout
{% endblock title %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/checkout.css' %}">
<section class="bg-light py-4 my-5">
    <div class="container">
        <h2 class="mb-4">Checkout</h2>
        
        <div class="row">
            <!-- Order Summary -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4>Order Summary</h4>
                    </div>
                    <div class="card-body">
                        {% if cart_items %}
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Quantity</th>
                                        <th>Price</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in cart_items %}
                                    <tr>
                                        <td>{{ item.product.name }}</td>
                                        <td>{{ item.quantity }}</td>
                                        <td>Rs. {{ item.product.selling_price }}</td>
                                        <td>Rs. {{ item.total_price }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                            <hr>
                            <h5 class="text-right">Total: Rs. {{ total_price }}</h5>
                        {% else %}
                            <p>Your cart is empty.</p>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Shipping Information -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4>Shipping Information</h4>
                    </div>
                    <div class="card-body">
                        <form method="post" action="{% url 'place_order' %}" id="checkoutForm" onsubmit="return validateForm()">
                            {% csrf_token %}
                            
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="full_name" class="form-label">Full Name *</label>
                                    <input type="text" class="form-control" id="full_name" name="full_name" required value="{{ user.get_full_name|default:user.username }}">
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="email" class="form-label">Email *</label>
                                    <input type="email" class="form-control" id="email" name="email" required value="{{ user.email }}" oninput="validateEmail(this)">
                                    <div class="invalid-feedback" id="emailError">Please enter a valid email address</div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="address" class="form-label">Address *</label>
                                <textarea class="form-control" id="address" name="address" rows="3" required></textarea>
                            </div>

                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="city" class="form-label">City *</label>
                                    <input type="text" class="form-control" id="city" name="city" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="postal_code" class="form-label">Postal Code *</label>
                                    <input type="text" class="form-control" id="postal_code" name="postal_code" required>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label for="phone_number" class="form-label">Phone Number *</label>
                                <div class="input-group">
                                    <input type="tel" class="form-control" id="phone_number" name="phone_number" required 
                                           pattern="[0-9]{10}" maxlength="10" oninput="validatePhoneNumber(this)">
                                    <button type="button" class="btn btn-outline-primary" id="sendOtpBtn" onclick="sendOTP()">Send OTP</button>
                                </div>
                                <div class="invalid-feedback" id="phoneError">Please enter a valid 10-digit phone number</div>
                                
                                <div id="otpSection" class="mt-3" style="display: none;">
                                    <label for="otp" class="form-label">Enter OTP *</label>
                                    <div class="input-group">
                                        <input type="text" class="form-control" id="otp" name="otp" placeholder="Enter 6-digit OTP" maxlength="6">
                                        <button type="button" class="btn btn-outline-success" onclick="verifyOTP()">Verify OTP</button>
                                    </div>
                                    <div class="invalid-feedback" id="otpError">Please enter the correct OTP</div>
                                    <div class="valid-feedback" id="otpSuccess" style="display: none;">OTP verified successfully!</div>
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">Payment Method *</label>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" id="cod" value="cod" checked>
                                    <label class="form-check-label" for="cod">
                                        <i class="fas fa-money-bill-wave me-2"></i>Cash on Delivery
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" id="card" value="card">
                                    <label class="form-check-label" for="card">
                                        <i class="fas fa-credit-card me-2"></i>Credit/Debit Card
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="payment_method" id="upi" value="upi">
                                    <label class="form-check-label" for="upi">
                                        <i class="fas fa-mobile-alt me-2"></i>UPI Payment
                                    </label>
                                </div>
                            </div>

                            <div class="d-grid">
                                <button type="submit" class="btn btn-primary btn-lg" id="submitBtn" disabled>Place Order</button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Shipping Status Information -->
                <div class="card mt-4">
                    <div class="card-header">
                        <h4>Shipping Information & Status</h4>
                    </div>
                    <div class="card-body">
                        <div class="shipping-timeline">
                            <div class="timeline-item active">
                                <div class="timeline-icon">
                                    <i class="fas fa-shopping-cart"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6>Order Placed</h6>
                                    <p class="text-muted">Your order will be confirmed shortly</p>
                                </div>
                            </div>
                            <div class="timeline-item">
                            <div class="timeline-icon">
                                    <i class="fas fa-box"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6>Order Confirmed</h6>
                                    <p class="text-muted">We're preparing your items</极速赛车官网开奖结果p>
                                </div>
                            </div>
                            <div class="timeline-item">
                                <div class="timeline-icon">
                                    <i class="fas fa-shipping-fast"></i>
                                </div>
                                <div class="timeline-content">
                                    <h6>Shipped</h6>
                                    <p class="text-muted">Your order is on the way</p>
                                </div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <h6>Estimated Delivery:</h6>
                            <p class="text-success"><strong>3-5 business days</strong></p>
                            
                           
                            <h6>Shipping Method:</h6>
                            <p class="text-muted">Standard Shipping - Free</p>
                            
                            <h6>Order Status:</h6>
                            <p><span class="status-badge status-pending" id="order-status-badge">Pending</span></p>
                        </div>
                        
                        <div class="mt-3">
                            <button type="button" class="btn btn-outline-primary me-2" onclick="showArrivalDetails()">
                                <i class="fas fa-truck me-2"></i>Show Arrival Details
                            </button>
                            <button type="button" class="btn btn-outline-danger" onclick="showCancelModal()">
                                <i class="fas fa-times me-2"></i>Cancel Order
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
// Cancel Order Modal Functions
function showCancelModal() {
    const modal = document.createElement('div');
    modal.className = 'cancel-modal';
    modal.style.display = 'block';
    modal.style.position = 'fixed';
    modal.style.zIndex = '1050';
    modal.style.left = '0';
    modal.style.top = '0';
    modal.style.width = '100%';
    modal.style.height = '100%';
    modal.style.backgroundColor = 'rgba(0, 0, 0, 0.5)';
    
    modal.innerHTML = `
        <div style="background-color: white; margin: 15% auto; padding: 2rem; border-radius: 0.5rem; width: 90%; max-width: 500px; box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);">
            <h5>Are you sure you want to cancel your order?</h5>
            <div style="margin: 1rem 0;">
                <div style="margin-bottom: 0.5rem;">
                    <input type="radio" id="reason1" name="cancelReason" value="Changed my mind">
                    <label for="reason1">Changed my mind</label>
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <input type="radio" id="reason2" name="cancelReason" value="Found a better price">
                    <label for="reason2">Found a better price</label>
                </div>
                <div style="margin-bottom: 0.5rem;">
                    <input type="radio" id="reason3" name="cancelReason" value="Other">
                    <label for="reason3">Other</label>
                </div>
            </div>
            <button class="btn btn-danger" onclick="confirmCancelOrder()">Confirm Cancel</button>
            <button class="btn btn-secondary" onclick="closeModal()">Close</button>
        </div>
    `;
    document.body.appendChild(modal);
}

function closeModal() {
    const modal = document.querySelector('.cancel-modal');
    if (modal) {
        modal.remove();
    }
}

function confirmCancelOrder() {
    // Logic to cancel the order
    alert('Your order has been cancelled.');
    closeModal();
    window.location.href = "{% url 'categories' %}"; // Redirect to home categories page
}

// Arrival Details Function
function showArrivalDetails() {
    alert('Arrival details will be available once your order is shipped. Estimated delivery: 3-5 business days.');
}

// Real-time Shipping Address Preview
document.getElementById('full_name').addEventListener('input', function() {
    document.getElementById('preview-name').innerText = this.value;
});

document.getElementById('address').addEventListener('input', function() {
    document.getElementById('preview-address').innerText = this.value;
});

document.getElementById('city').addEventListener('input', function() {
    document.getElementById('preview-city').innerText = this.value + ', ' + document.getElementById('postal_code').value;
});

document.getElementById('postal_code').addEventListener('input', function() {
    document.getElementById('preview-city').innerText = document.getElementById('city').value + ', ' + this.value;
});

document.getElementById('phone_number').addEventListener('input', function() {
    document.getElementById('preview-phone').innerText = this.value;
});

document.getElementById('email').addEventListener('input', function() {
    document.getElementById('preview-email').innerText = this.value;
});

// Validation functions
function validatePhoneNumber(input) {
    const phone = input.value.replace(/\D/g, '');
    const phoneError = document.getElementById('phoneError');
    
    if (phone.length === 10 && /^\d+$/.test(phone)) {
        input.classList.remove('is-invalid');
        input.classList.add('is-valid');
        phoneError.style.display = 'none';
        return true;
    } else {
        input.classList.remove('is-valid');
        input.classList.add('is-invalid');
        phoneError.style.display = 'block';
        return false;
    }
}

function validateEmail(input) {
    const email = input.value;
    const emailError = document.getElementById('emailError');
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    
    if (emailRegex.test(email)) {
        input.classList.remove('is-invalid');
        input.classList.add('is-valid');
        emailError.style.display = 'none';
        return true;
    } else {
        input.classList.remove('is-valid');
        input.classList.add('is-invalid');
        emailError.style.display = 'block';
        return false;
    }
}

function validateForm() {
    const phoneValid = validatePhoneNumber(document.getElementById('phone_number'));
    const emailValid = validateEmail(document.getElementById('email'));
    const otpVerified = document.getElementById('otpSuccess').style.display === 'block';
    
    if (!phoneValid || !emailValid || !otpVerified) {
        if (!phoneValid) {
            document.getElementById('phoneError').style.display = 'block';
        }
        if (!emailValid) {
            document.getElementById('emailError').style.display = 'block';
        }
        if (!otpVerified) {
            document.getElementById('otpError').style.display = 'block';
        }
        return false;
    }
    return true;
}

// OTP functions (placeholder - needs backend integration)
function sendOTP() {
    const phoneInput = document.getElementById('phone_number');
    if (!validatePhoneNumber(phoneInput)) {
        return;
    }
    
    const phone = phoneInput.value;
    const sendOtpBtn = document.getElementById('sendOtpBtn');
    
    // Show loading state
    sendOtpBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Sending...';
    sendOtpBtn.disabled = true;
    
    // Simulate API call (replace with actual backend integration)
    setTimeout(() => {
        // Show OTP section
        document.getElementById('otpSection').style.display = 'block';
        
        // Reset button
        sendOtpBtn.innerHTML = 'Resend OTP';
        sendOtpBtn.disabled = false;
        
        // For demo purposes, show the OTP in console (remove in production)
        const demoOtp = '123456';
        console.log('Demo OTP for phone', phone, ':', demoOtp);
        alert('OTP sent! Check console for demo OTP: ' + demoOtp);
    }, 2000);
}

function verifyOTP() {
    const otpInput = document.getElementById('otp');
    const otp = otpInput.value;
    const otpError = document.getElementById('otpError');
    const otpSuccess = document.getElementById('otpSuccess');
    const submitBtn = document.getElementById('submitBtn');
    
    // Simple validation - in production, verify against backend
    if (otp.length === 6 && /^\d+$/.test(otp)) {
        otpInput.classList.remove('is-invalid');
        otpInput.classList.add('is-valid');
        otpError.style.display = 'none';
        otpSuccess.style.display = 'block';
        submitBtn.disabled = false;
    } else {
        otpInput.classList.remove('is-valid');
        otpInput.classList.add('is-invalid');
        otpError.style.display = 'block';
        otpSuccess.style.display = 'none';
        submitBtn.disabled = true;
    }
}

// Real-time validation
document.getElementById('phone_number').addEventListener('input', function() {
    validatePhoneNumber(this);
});

document.getElementById('email').addEventListener('input', function() {
    validateEmail(this);
});

document.getElementById('otp').addEventListener('input', function() {
    if (this.value.length === 6 && /^\d+$/.test(this.value)) {
        this.classList.remove('is-invalid');
        this.classList.add('is-valid');
        document.getElementById('otpError').style.display = 'none';
    }
});
</script>
{% endblock content %}